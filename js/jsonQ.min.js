/*
 *jsonQ.js v 1.0.1
 *Author: Sudhanshu Yadav
 *s-yadav.github.com
 *Copyright (c) 2013 Sudhanshu Yadav.
 *Dual licensed under the MIT and GPL licenses
 */

;(function(undefined){function matchPath(e,t){var n=new RegExp("^"+e.join("~~"),"i");return n.test(t.join("~~"))}function newFormat(e){var t=e.keyAdded||[],n=e.json,r=e.path,i=e.newJson;jsonQ.each(n,function(e,s){var o=r?JSON.parse(JSON.stringify(r)):[];o.push(e);if(objType(n)=="object"){if(t.indexOf(e)==-1){t.push(e);i[e]=[]}i[e].push({path:o})}var u=objType(s);if(u=="object"||u=="array"){newFormat({json:s,newJson:i,path:o,keyAdded:t})}});return i}var jsonQ=function(e){return new jsonQ.fn.init(e)},error=function(e){throw e},stringify=JSON.stringify,parse=JSON.parse;jsonQ.settings={sort:{order:"ASC",logic:function(e){return e},caseIgnore:true,allLevel:true}};window.jsonQ=jsonQ;var tFunc={topLevel:function(e){var t=this.jsonQ_current,n=this.cloneObj(jsonQ()),r=n.jsonQ_current=[],i="",s=e.key,o=e.method;for(var u=0,a=t.length;u<a;u++){var f=t[u].path,l,c=false,h=f.concat([]);if(o=="parent"){if(h.length===0){c=true}else{h.pop()}}else{var p=h.lastIndexOf(s);if(p==-1){c=true}else{h=h.slice(0,p+1)}}l=JSON.stringify(h);if(i!=l&&!c){r.push({path:h})}i=l}n.length=r.length;n.selector.push({method:o,key:s});return n},qualTrv:function(e){var t=this.jsonQ_current,n=this.cloneObj(jsonQ()),r=n.jsonQ_current=[],i=e.key,s=jsonQ.clone(this[i])||[],o=e.qualifier,u=objType(o),a=e.method,f=a=="find"?true:false;for(var l=0,c=t.length;l<c;l++){var h=t[l].path,p=false;if(!f){if(h.length===0){continue}var d=h.concat([]);d.pop()}for(var v=0;v<s.length;v++){var m=s[v].path,g;if(f){g=matchPath(h,m)}else{var y=m.concat([]);y.pop();g=d.join()==y.join()}if(g){var b=tFunc.qTest.call(this,u,o,m,r);if(b){s.splice(v,1);v--}p=true}else if(p){break}}}if(u=="string"){n=this.filter.call(n,o)}n.length=n.jsonQ_current.length;n.selector.push({method:a,key:i,qualifier:o});return n},qTest:function(e,t,n,r){var i=e=="function"?t.call(this.pathValue(n)):e=="object"?jsonQ.checkKeyValue(this.pathValue(n),t):true;if(i){r.push({path:n})}return i}};var sortFunc={baseConv:function(e,t,n){if(e=="string"){if(n.caseIgnore){return t.toLowerCase()}}else if(e=="array"){return t.join()}else if(e=="object"){return stringify(jsonQ.order(t))}return t},sortAry:function(e,t,n){e.sort(function(e,n){var r=t(e);var i=t(n);return r<i?-1:r>i?1:0});if(n.order.toLowerCase()=="desc"){e.reverse()}return e}};jsonQ.fn=jsonQ.prototype={init:function(e){var t;if(!e)return this;t=objType(e);if(t!="object"&&t!="array"){error("Not a valid json");return e}this.jsonQ_root=e;this.jsonQ_current=[{path:[]}];newFormat({json:e,newJson:this,refresh:true});this.length=this.jsonQ_current.length;this.selector=[];return this},pathValue:function(e){return jsonQ.pathValue(this.jsonQ_root,e)},setPathValue:function(e,t){jsonQ.setPathValue(this.jsonQ_root,e,t);return this},clone:function(){return parse(stringify(this.jsonQ_current))},cloneObj:function(e){var t=this;e=e||{};jsonQ.each(t,function(t,n){e[t]=n});e.selector=jsonQ.merge([],e.selector);return e},value:function(e,t){var n=this.jsonQ_current;t=t===false?false:true;if(!e){var r=[];this.each(function(e,t,n){r.push(n)});return r}else{var i=objType(e);for(var s=0,o=n.length;s<o;s++){var u=n[s].path,a;if(i=="function"){var f=this.pathValue(u);a=t?jsonQ.clone(e(f)):e(f)}else{a=t?jsonQ.clone(e):e}this.setPathValue(u,a)}return this}},append:function(e,t){return this.appendAt("last",e,t)},prepend:function(e,t){return this.appendAt("first",e,t)},appendAt:function(e,t,n){var r=this.jsonQ_current;if(isNaN(e)&&e!="first"&&e!="last"){error(e+"is not a valid index.");return this}for(var i=0,s=r.length;i<s;i++){var o=r[i].path.concat([]),u=o.pop(),a=this.pathValue(o),f=objType(a[u]),l=a[u].length;var c=e<0||e=="first"?0:e>l||e=="last"?l:e;if(f=="array"){t=n?jsonQ.clone(t):t;a[u].splice(c,0,t)}else if(f=="string"){var h=a[u];a[u]=h.substring(0,c)+t+h.substring(c,l)}}return this},filter:function(e){var t=this.jsonQ_current,n=this.cloneObj(jsonQ()),r=n.jsonQ_current=[],i=objType(e);if(!e)return;for(var s=0,o=t.length;s<o;s++){var u=t[s].path;tFunc.qTest.call(this,i,e,u,r)}if(i=="string"){var a=/(nth|eq)\((.+)\)/,f=a.exec(e);if(f){r=jsonQ.nthElm(t,f[2],true)}else{r=jsonQ.nthElm(t,e,true)}n.jsonQ_current=r}n.length=r.length;n.selector.push({method:"filter",qualifier:e});return n},find:function(e,t){return tFunc.qualTrv.call(this,{method:"find",key:e,qualifier:t})},sibling:function(e,t){return tFunc.qualTrv.call(this,{method:"sibling",key:e,qualifier:t})},parent:function(){return tFunc.topLevel.call(this,{method:"parent"})},closest:function(e){return tFunc.topLevel.call(this,{method:"closest",key:e})},path:function(){return this.jsonQ_current[0].path},firstElm:function(){return this.pathValue(this.jsonQ_current[0].path)},lastElm:function(){return this.pathValue(this.jsonQ_current[this.length-1].path)},nthElm:function(e,t){return jsonQ.nthElm(this.value(),e,t)},index:function(e,t){return jsonQ.index(this.value(),e,t)},createXML:function(){return jsonQ.createXML(this.value())},sort:function(e,t){t=jsonQ.merge({},jsonQ.settings.sort,t);var n=this.find(e),r=n.clone(),i=[],s,o,u=[],a=objType(n.pathValue(r[0].path)),f=function(e){while(e.length!==0){var t=e.pop();if(!isNaN(t)){var r=n.pathValue(e);if(objType(r)=="array"){return r}}}return null};for(s=0,o=r.length;s<o;s++){i.push({pathHolder:r[s].path.concat([]),current:r[s].path.concat([])})}var l=0,c=function(e){i.splice(e,1);return--e};while(i.length!==0){l++;for(s=0;s<i.length;s++){var h=i[s].current,p=i[s].pathHolder,d=f(h),v=h.join();if(h.length===0||u.indexOf(v)!=-1){s=c(s)}else{var m=p.slice(h.length+1,p.length),g=function(e){var n=jsonQ.pathValue(e,m);n=sortFunc.baseConv(a,n,t);return t.logic(n)};sortFunc.sortAry(d,g,t);if(t.allLevel){p[h.length]=0;u.push(v)}else{s=c(s)}}}}return jsonQ(n.jsonQ_root).find(e)},each:function(e){var t=this.jsonQ_current;for(var n=0,r=t.length;n<r;n++){e(n,t[n].path,this.pathValue(t[n].path))}return this},unique:function(){return jsonQ.unique(this.value())},refresh:function(){var e=this.selector;var t=jsonQ(this.jsonQ_root);for(var n=0,r=e.length;n<r;n++){var i=e[n],s=[];if(i.key)s.push(i.key);if(i.qualifier)s.push(i.qualifier);t=t[i.method].apply(t,s)}this.cloneObj.call(t,this);return this},prettify:function(e){return jsonQ.prettify(this.value(),e)}};jsonQ.each=function(e,t){for(var n in e){if(e.hasOwnProperty(n)){t(n,e[n])}}};var objType=jsonQ.objType=function(){var e={"[object Array]":"array","[object Object]":"object","[object String]":"string","[object Number]":"number","[object Boolean]":"boolean","[object Null]":"null","[object Function]":"function"};return function(t){var n=Object.prototype.toString.call(t);return e[n]}}();jsonQ.merge=function(){var e=arguments,t=objType(e[0]),n=1,r=e.length,i=false,s=e[0];if(r===0||t=="boolean"&&r==1){return}if(t=="boolean"){s=e[1];n=2;i=e[0]}var o=function(e,t){var n=objType(t),r=objType(s[e]);if(i&&(n=="array"||n=="object")){s[e]=n==r&&(r=="array"||r=="object")?s[e]:n=="array"?[]:{};jsonQ.merge(i,s[e],t)}else{s[e]=t}};for(;n<r;n++){jsonQ.each(e[n],o)}return s};jsonQ.merge(jsonQ,{sort:function(e,t){t=jsonQ.merge({},jsonQ.settings.sort,t);if(objType(e)!="array"){error("Only array is allowed to sort");return}var n=function(e){var n=objType(e);e=sortFunc.baseConv(n,e,t);return t.logic(e)};return sortFunc.sortAry(e,n,t)},order:function(e){if(typeof e!="object"){return e}var t=function(e){if(!isNaN(e))e=parseInt(e);return e},n=function(e){var r=objType(e),i=Object.keys(e);if(r=="object"){i.sort(function(e,n){var r=t(e);var i=t(n);return r<i?-1:r>i?1:0})}for(var s=0,o=i.length;s<o;s++){var u=i[s],a=e[u],f=objType(a);if(f=="object"||f=="array"){n(a)}if(r=="object"){delete e[u];e[u]=a}}};n(e);return e},clone:function(e){var t=objType(e);return t=="object"||t=="array"?parse(stringify(e)):e},index:function(e,t,n){var r=objType(t),i=e.length,s=r=="object"||r=="array"||r=="function"?true:false;if(r=="function"){n=true}if(s&&!n){var o=stringify(jsonQ.order(t))}for(var u=0;u<i;u++){var a=e[u];if(s){var f=objType(a);if(f!=r&&!n)continue;if(!n){if(stringify(jsonQ.order(a))==o){return u}}else{var l;if(r=="function"){l=t.call(a)}else if(r=="object"&&f=="object"){l=jsonQ.checkKeyValue(a,t)}else if(f=="array"){if(r=="array"){for(var c=0,h=t.length;c<h;c++){l=jsonQ.index(a,t[c])!=-1;if(!l)break}}else{l=jsonQ.index(a,t)!=-1}}if(l)return u}}else if(t==a){return u}}return-1},contains:function(e,t,n){return jsonQ.index(e,t,n)!=-1},checkKeyValue:function(e,t){for(var n in t){if(t.hasOwnProperty(n))if(!jsonQ.identical(t[n],e[n]))return false}return true},nthElm:function(array,arg,aryRetrn){var result;if(array[arg]){result=array[arg]}else if(arg=="last"){result=array[array.length-1]}else if(arg=="first"){result=array[0]}else if(arg=="random"){var rand=Math.floor(Math.random()*array.length);result=array[rand]}else if(arg=="even"){result=jsonQ.nthElm(array,"2n")}else if(arg=="odd"){result=jsonQ.nthElm(array,"2n+1")}else{try{var newArray=[],ln=array.length;if(!arg.match(/^[0-9n*+-\/]+$/))throw"";arg=arg.replace(/([0-9])n/g,function(e,t){return t?t+"*n":e});for(var n=0;n<ln;n++){var index=eval(arg);if(index>ln-1){break}newArray.push(array[index])}result=newArray}catch(error){result=array}}result=result||array;return objType(result)!="array"&&aryRetrn?[result]:result},prettify:function(e,t){if(typeof e!="object"){throw"Only valid json object is allowed."}if(t){return JSON.stringify(e,null,"	").replace(/\n/g,"</br>").replace(/\t/g,"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;")}return JSON.stringify(e,null,3)},identical:function(e,t){function n(e){if(typeof e!=="object"||e===null){return e}return Object.keys(e).sort().map(function(t){return{key:t,value:n(e[t])}})}return JSON.stringify(n(e))===JSON.stringify(n(t))},union:function(){var e=arguments,t=[],n=e.length;for(var r=0;r<n;r++){var i=e[r].length;for(var s=0;s<i;s++){var o=e[r][s];if(jsonQ.index(t,o)==-1){t.push(o)}}}return t},intersection:function(){var e=arguments,t=[],n,r=e.length;if(r==1){t=e[0]}else{for(var i=0,s=e[0].length;i<s;i++){var o=e[0][i];n=1;for(var u=1;u<r;u++){if(jsonQ.index(e[u],o)==-1){n=0;break}}if(n==1){t.push(o)}}}return t},suffle:function(e){for(var t=1,n=e.length;t<n;t++){var r=Math.floor(Math.random()*(t+1)),i=e[t];e[t]=e[r];e[r]=i}return e},unique:function(e){var t=e.length,n=[];for(var r=0;r<t;r++){if(jsonQ.index(n,e[r])==-1){n.push(e[r])}}return n},pathValue:function(e,t){var n=0,r=t.length;if(e===null){return null}while(n<r){if(e[t[n]]===null){e=null;return}else{e=e[t[n]]}n=n+1}return e},setPathValue:function(e,t,n){var r=0,i=e,s=t.length;if(e===null){return null}while(r<s){if(typeof i[t[r]]!="object"){i[t[r]]=objType(t[r+1])=="number"?[]:{}}if(r==t.length-1){i[t[r]]=n}i=i[t[r]];r=r+1}return e},createXML:function(e){var t=function(e,n){n=n||[];var r=n.length===0?true:false,i=objType(e);if(r){n.push('<?xml version="1.0" encoding="ISO-8859-1"?><jsonXML>')}jsonQ.each(e,function(e,r){var s=i=="array"?"arrayItem":e,o=objType(r);n.push("<"+s+' type="'+o+'">');if(o=="object"||o=="array"){t(r,n)}else{n.push("<![CDATA["+r+"]]>")}n.push("</"+s+">")});if(r){n.push("</jsonXML>");return n.join("")}else{return n}};return t(e)},append:function(e,t,n){return jsonQ.appendAt(e,"last",t,n)},prepend:function(e,t,n){return jsonQ.appendAt(e,"first",t,n)},appendAt:function(e,t,n,r){if(isNaN(t)&&t!="first"&&t!="last"){error(t+"is not a valid index.");return}var i=objType(e),s=e.length;var o=t<0||t=="first"?0:t>s||t=="last"?s:t;if(i=="array"){n=r?jsonQ.clone(n):n;e.splice(o,0,n)}else if(i=="string"){e=e.substring(0,o)+n+e.substring(o,s)}return e}});jsonQ.fn.init.prototype=jsonQ.fn})();